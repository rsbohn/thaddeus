;; Thaddeus Runtime
;; A Little Smalltalk system
;; Copyright (c) Randall Bohn 2019
;; 2019 0724
;; MIT License: see LICENSE file
;; $ acme runtime.a
	!to "runtime.bin", plain

	* = $1000

boot:	!word FIN-$1000
	!word $C00A
	!word Runtime
	!word starter

	Nil = $EFF0
;; This is the new Application.
!zone starter {
starter:
	!word $0007
	!word $C00D
	!word .name
	!word .code
	!word .literals
	!word $0010
	!word $0010	;; tempSize
	!word Runtime
	!word Nil
.name
	!word $8007
	!word $C010
	!raw "starter"
	!align 1,0
.literals
	!word $0008
	!word $C00A
	!word setup
	!word loop
	!word .sargs
	!word .largs
	!word $0000
	!word $0000
	!word $0000
	!word $0000
.code
	!word $8000
	!word $C00B
	!hex 4290F5
	!hex 4391F5
	!hex F60300
	!align 1,0
.sargs
	!word $0001
	!word $C00A
	!word $8000	;; starter temps array is the receiver
	!word $0400	;; count for ticker
.largs
	!word $0001
	!word $C00A
	!word $8000	;; starter temps array is the receiver
}

!zone runtime {
Runtime:
	!word $0008
	!word $C00A	;; Runtime is just an array
	!word $8080
	!word $8090
	!word $0000
	!word $0000
	!word $0000
	!word $0000
	!word $0000
	!word $0000
}

!zone setup {
setup:
	!word $0007
	!word $C00D
	!word .name
	!word .code
	!word .literals
	!word $0010
	!word $0000
	!word Runtime
	!word Nil
.name
	!word $8005
	!word $C010
	!raw "setup"
	!align 1,0
.literals
	!word $0004
	!word $C00A
	!word Runtime
	!word .args
	!word $0003
	!word putString
.code
	!word $0008
	!word $C00B
	!hex 4193F5	;; putString pztag
	!hex 40218260	;; args for ticker
	!hex F1
	!align 1,0
.args
	!word $0003
	!word $C00A
	!word Runtime
	!word pztag
	!word $0000
}

!zone loop {
loop:
	!word $0007
	!word $C00D
	!word .name
	!word .code
	!word .literals
	!word $0010
	!word $0000
	!word Runtime
	!word Nil
.name
	!word $0004
	!word $C010
	!raw "loop"
.literals
	!word $0004
	!word $C00A
	!word .psargs
	!word $001F
	!word putString
	!word $00F8	;; line 3 col 8
	!word pztag	;; 44
	!word blanks
	!word ticker
	!word messages
	!word $0020	;; 48 lcd width
	!word $0050	;; screen width
	!word $00E0	;; 4A message mask
.code
	!word $0024
	!word $C00B
	;; first calculate the destination
	!hex 2043D20A63	;; store $8000 in RIV[3]
	;; <blit _src_ sbank dest dbank count>
	!hex 485113501447D20AD530

	!hex 1349D20A63	;; next row
	!hex 1448D20A4AD22564	;; next message
	!hex 485113501447D20AD530

	!hex 1349D20A63	;; next row
	!hex 1448D20A4AD22564	;; next message
	!hex 485113501447D20AD530

	!hex 1349D20A63	;; next row
	!hex 1448D20A4AD22564	;; next message
	!hex 485113501447D20AD530

	;; now back up 2 messages for the next iteration
	;; @B W W + - M & !
	!hex 144848D20AD2104AD22564
	!hex 1096F5	;; sleep a bit
	!hex F1
	!align 1,0
.alternate
	!word $0024
	!word $C00B
	!hex 454052D305	;; putString blanks
	!hex 4092F5
	!hex 5A11D20A	;; XB--
	!hex 41D22561	;; XB &= 0x1F
	!hex 4311D20A	;; XB + $50 * 3
	!hex 4053D305	;; <05 __ .psargs 03>
	!hex 444052D305	;; putString pztag
	!hex 4092F5	;; putString
	!hex 1096F5F1
	!align 1,0
.psargs
	!word $0003
	!word $C00A
	!word Runtime
	!word pztag
	!word $0050*3+8
}

!zone putString {
putString:	;; [runtime string offset] print string at screen[offset]
	!word $0007
	!word $C00D
	!word .name
	!word .code
	!word .literals
	!word $0010	;stackSize
	!word $0000	;tempSize
	!word Runtime
	!word Nil	;no text
.name
	!word $8009
	!word $C010
	!raw "putString"
	!align 1,0
.literals
	!word $0001
	!word $C00A
	!word $8000	;screen initial offset
.code
	!word $8010
	!word $C00B
	!hex 21D10451	;i(dbank count)
	!hex 4022D20A	;add offset to screen base i(dest dbank count)
	!hex 50		;i(sbank dest dbank count)
	!hex 2154D20A	;string[data] i(src sbank dest dbank count)
	!hex D530	;blit i()
	!hex F1		;return self
	!align 1,0
}

!zone ticker {

ticker:
        !word $0007
        !word $C00D
        !word .name
        !word .code
        !word .literals
        !word $0010
        !word $0000
        !word Runtime
        !word Nil
.name
        !word $8007
        !word $C010
        !raw "ticker:"
        !align 1,0
.literals
        !word $0001
        !word $C00A
        !word $FFFF
.code
        !word $800C
        !word $C00B
        !hex 2140D20A
        !hex F450D201
        !hex F80100
        !hex F1
}

pztag:	!word $0018
	!word $C010
	!raw "Pluton/0 65816 Computer "
blanks:	!word $0050
	!word $C010
	!fill $20, $20

messages:
	!raw "................................"
	!raw "65816 Processor 4MHz ..........."
	!raw "2048 KB RAM ...................."
	!raw "4K ROM Monitor/Smalltalk ......."
	!raw "6845 Screen 80x24 Monochrome ..."
	!raw "2x Serial Ports 6551 ..........."
	!raw "1x VIA6522 ....................."
	!raw "1x AY3-8910 Audio .............."

FIN:
