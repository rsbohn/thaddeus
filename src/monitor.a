;; rsbohn 2019-05-20
;; piebox monitor.a
	!cpu 65816

	RA = $00
	RB = $04
	RC = $08
	RD = $0C
	RS = $10
	RW = $14

	KCHAN = $18
	SPLIT = $1A

	TIB	= $6F00
	STACK	= $7FFF
	NVECT	= $FFE8
	EVECT	= $FFFA

	!source "src/macros.a"
	
	* = $F000
COLD:
	CLC
	XCE
	CLI

	+long
	LDA MSTACK
	TCS

	JSR ICONSOLE
	JSR TIBCLEAR
	JMP MAIN

MTIB:	!word TIB
MSTACK: !word STACK


MAIN:
	+short
	JSR PROMPT
	LDA MSPACE
-	JSR CHOUT
	JSR CHIN
	PHA
	CMP NEWLINE
	BEQ +
	PLA
	STA (RD)
	INC RD
	BNE -
	;; TIB overflow

+	PLA
	JSR GOTLINE
	BRA MAIN

TIBCLEAR:
	+long
	LDA MTIB
	STA RD
	+short
	LDA CH+0
	TAY
	DEY
-	STA (RD),Y
	DEY
	BNE -
	STA (RD)
	RTS

PROMPT:
	JSR CRLF
	LDA MPROMPT
	JSR CHOUT
	RTS

GOTLINE:
	JSR ECHOLINE
	JSR TIBCLEAR
	RTS

ECHOLINE:
	JSR CRLF
	+short
	STZ RD
-	LDA (RD)
	BEQ +
	JSR CHOUT
	INC RD
	BRA -
+	RTS
;;;;;;;;;;;;;;;;;;;;

FVOUT:
	!byte $10
FVIN:
	!byte $08
CONSOLE:
	!word $0810
CONCTL:
	!word $071E
ICONSOLE:
	;; initialize serial console
	+long
	PHY
	PHA
	LDA CONSOLE
	STA KCHAN
	+short
	LDY CH+03
	LDA CONCTL
	STA (KCHAN),Y
	LDA CONCTL+1
	DEY
	STA (KCHAN),Y
	+long
	PLA
	PLY
	RTS

CHIN:
	+short
	PHY
	LDY CH+01
-	LDA FVIN
	AND (KCHAN),Y
	BEQ -
	LDA (KCHAN)
	PLY
	RTS
	
CHOUT:
	+short
	PHY
	PHA
	LDY CH+01
-	LDA FVOUT
	AND (KCHAN),Y
	BEQ -
	PLA
	DEY
	STA (KCHAN),Y
	PLY
	RTS
CRLF:
	+short
	LDA NEWLINE
	JSR CHOUT
	LDA NEWLINE+1
	JSR CHOUT
	RTS

;;;;;;;;;;;;;;;;;;;;;;;;;;;
	!source "src/bytecodes.a"
;;;;;;;;;;;;;;;;;;;;;;;;;;;

	* = $FFC0
CH:
	!byte 0,1,2,3,4,5,6,7,8,9

MPROMPT:
	!byte '?'
MSPACE:
	!byte $20
NEWLINE:
	!byte $0A, $0D


	* = $FFF0
ERESET:
	JMP COLD
NVIRQ:
HANG:
	BRA HANG
NVABORT:
NVNMI:
NVBRK:
ENMI:
EIRQ:
	JMP HANG
	
	* = NVECT
	!word NVABORT
	!word NVNMI
	!word NVBRK
	!word NVIRQ
	
	* = EVECT
	!word ENMI
	!word ERESET
	!word EIRQ
	
